<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComposableArchitecture - TestStore</title>
    <link rel="stylesheet" type="text/css" href="/swift-composable-architecture/all.css" media="all" />
</head>
<body>
    <header>
        <a href="/swift-composable-architecture/">
            <strong>
                ComposableArchitecture
            </strong>
            <span>Documentation</span>
        </a>
    </header>

    <!--
    <form class="search">
        <input type="search" placeholder="Search" />
    </form>
    -->

    <nav>
        <div class="wrapper">
            <h2>On This Page</h2>
            <ol><li><a href="#relationships">Relationships</a><ul><li><a href="#relationships">Nested Types</a></li></ul></li><li><a href="#properties">Properties</a><ul><li class="variable"><a href="#teststore.environment">environment</a></li></ul></li><li><a href="#methods">Methods</a><ul><li class="function"><a href="#teststore.scope(state:action:)">scope(state:​action:​)</a></li><li class="function"><a href="#teststore.scope(state:)">scope(state:​)</a></li></ul></li></ol>
        </div>
    </nav>

    <main>
        <article>
            <h1>
    <small>Class</small>
    <code class="name">Test​Store</code>
</h1>

<div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="attribute">final</span> <span class="keyword">class</span> <span class="type">TestStore</span>&lt;<span class="variable">State</span>, <span class="variable">LocalState</span>, <span class="variable">Action</span>, <span class="variable">LocalAction</span>, <span class="variable">Environment</span>&gt;  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>A testable runtime for a reducer.</p>

</div>
<div class="discussion">
    <p>This object aids in writing expressive and exhaustive tests for features built in the
Composable Architecture. It allows you to send a sequence of actions to the store, and each
step of the way you must assert exactly how state changed, and how effect emissions were fed
back into the system.</p>

<p>There are multiple ways the test store forces you to exhaustively assert on how your feature
behaves:</p>

<ul>
<li>
<p>After each action is sent you must describe precisely how the state changed from before
the action was sent to after it was sent.</p>
<p>If even the smallest piece of data differs the test will fail. This guarantees that you
are proving you know precisely how the state of the system changes.</p>
</li>
<li>
<p>Sending an action can sometimes cause an effect to be executed, and if that effect emits
an action that is fed back into the system, you <strong>must</strong> explicitly assert that you expect
to receive that action from the effect, <em>and</em> you must assert how state changed as a
result.</p>
<p>If you try to send another action before you have handled all effect emissions the
assertion will fail. This guarantees that you do not accidentally forget about an effect
emission, and that the sequence of steps you are describing will mimic how the application
behaves in reality.</p>
</li>
<li>
<p>All effects must complete by the time the assertion has finished running the steps you
specify.</p>
<p>If at the end of the assertion there is still an in-flight effect running, the assertion
will fail. This helps exhaustively prove that you know what effects are in flight and
forces you to prove that effects will not cause any future changes to your state.</p>
</li>
</ul>

<p>For example, given a simple counter reducer:</p>

<html><body><pre class="highlight"><code><span class="keyword">struct</span> <span class="type">CounterState</span> {
  <span class="keyword">var</span> <span class="variable">count</span> = <span class="number literal">0</span>
}

<span class="keyword">enum</span> <span class="type">CounterAction</span>: <span class="type">Equatable</span> {
  <span class="keyword">case</span> <span class="variable">decrementButtonTapped</span>
  <span class="keyword">case</span> <span class="variable">incrementButtonTapped</span>
}

<span class="keyword">let</span> <span class="variable">counterReducer</span> = <span class="variable">Reducer</span>&lt;<span class="type">CounterState</span>, <span class="type">CounterAction</span>, <span class="type">Void</span>&gt; { <span class="variable">state</span>, <span class="variable">action</span>, <span class="keyword">_</span> <span class="keyword">in</span>
  <span class="keyword">switch</span> <span class="variable">action</span> {
  <span class="keyword">case</span> .<span class="variable">decrementButtonTapped</span>:
    <span class="type">state</span>.<span class="variable">count</span> -= <span class="number literal">1</span>
    <span class="keyword">return</span> .<span class="variable">none</span>

  <span class="keyword">case</span> .<span class="variable">incrementButtonTapped</span>:
    <span class="type">state</span>.<span class="variable">count</span> += <span class="number literal">1</span>
    <span class="keyword">return</span> .<span class="variable">none</span>
  }
}
</code></pre></body></html>
<p>One can assert against its behavior over time:</p>

<html><body><pre class="highlight"><code><span class="keyword">class</span> <span class="type">CounterTests</span>: <span class="type">XCTestCase</span> {
  <span class="keyword">func</span> <span class="function">testCounter</span>() {
    <span class="keyword">let</span> <span class="variable">store</span> = <span class="variable">TestStore</span>(
      <span class="variable">initialState</span>: .<span class="variable">init</span>(<span class="variable">count</span>: <span class="number literal">0</span>),     <span class="comment">// GIVEN counter state of 0</span>
      <span class="variable">reducer</span>: <span class="type">counterReducer</span>,
      <span class="variable">environment</span>: ()
    )
    <span class="variable">store</span>.<span class="variable">send</span>(.<span class="variable">incrementButtonTapped</span>) { <span class="comment">// WHEN the increment button is tapped</span>
      <span class="variable">$0</span>.<span class="variable">count</span> = <span class="number literal">1</span>                       <span class="comment">// THEN the count should be 1</span>
    }
  }
}
</code></pre></body></html>
<p>Note that in the trailing closure of <code>.send(.incrementButtonTapped)</code> we are given a single
mutable value of the state before the action was sent, and it is our job to mutate the value
to match the state after the action was sent. In this case the <code>count</code> field changes to <code>1</code>.</p>

<p>For a more complex example, consider the following bare-bones search feature that uses the
<code>Effect/debounce(id:for:scheduler:options:)</code> operator to wait for the user to stop typing
before making a network request:</p>

<html><body><pre class="highlight"><code><span class="keyword">struct</span> <span class="type">SearchState</span>: <span class="type">Equatable</span> {
  <span class="keyword">var</span> <span class="variable">query</span> = <span class="string literal">"</span><span class="string literal"/><span class="string literal">"</span>
  <span class="keyword">var</span> <span class="variable">results</span>: [<span class="type">String</span>] = []
}

<span class="keyword">enum</span> <span class="type">SearchAction</span>: <span class="type">Equatable</span> {
  <span class="keyword">case</span> <span class="variable">queryChanged</span>(<span class="type">String</span>)
  <span class="keyword">case</span> <span class="variable">response</span>([<span class="type">String</span>])
}

<span class="keyword">struct</span> <span class="type">SearchEnvironment</span> {
  <span class="keyword">var</span> <span class="variable">mainQueue</span>: <span class="type">AnySchedulerOf</span>&lt;<span class="type">DispatchQueue</span>&gt;
  <span class="keyword">var</span> <span class="variable">request</span>: (<span class="type">String</span>) -&gt; <a href="/swift-composable-architecture/Effect"><span class="type">Effect</span></a>&lt;[<span class="type">String</span>], <span class="type">Never</span>&gt;
}

<span class="keyword">let</span> <span class="variable">searchReducer</span> = <span class="variable">Reducer</span>&lt;<span class="type">SearchState</span>, <span class="type">SearchAction</span>, <span class="type">SearchEnvironment</span>&gt; {
  <span class="variable">state</span>, <span class="variable">action</span>, <span class="variable">environment</span> <span class="keyword">in</span>

    <span class="keyword">struct</span> <span class="type">SearchId</span>: <span class="type">Hashable</span> {}

    <span class="keyword">switch</span> <span class="variable">action</span> {
    <span class="keyword">case</span> <span class="keyword">let</span> .<span class="variable">queryChanged</span>(<span class="variable">query</span>):
      <span class="type">state</span>.<span class="variable">query</span> = <span class="variable">query</span>
      <span class="keyword">return</span> <span class="variable">environment</span>.<span class="variable">request</span>(<span class="keyword">self</span>.<span class="variable">query</span>)
        .<span class="variable">debounce</span>(<span class="variable">id</span>: <span class="type">SearchId</span>(), <span class="variable">for</span>: <span class="number literal">0.5</span>, <span class="variable">scheduler</span>: <span class="type">environment</span>.<span class="variable">mainQueue</span>)

    <span class="keyword">case</span> <span class="keyword">let</span> .<span class="variable">response</span>(<span class="variable">results</span>):
      <span class="type">state</span>.<span class="variable">results</span> = <span class="variable">results</span>
      <span class="keyword">return</span> .<span class="variable">none</span>
    }
}
</code></pre></body></html>
<p>It can be fully tested by controlling the environment's scheduler and effect:</p>

<html><body><pre class="highlight"><code><span class="comment">// Create a test dispatch scheduler to control the timing of effects</span>
<span class="keyword">let</span> <span class="variable">scheduler</span> = <span class="variable">DispatchQueue</span>.<span class="variable">test</span>

<span class="keyword">let</span> <span class="variable">store</span> = <span class="variable">TestStore</span>(
  <span class="variable">initialState</span>: <span class="type">SearchState</span>(),
  <span class="variable">reducer</span>: <span class="type">searchReducer</span>,
  <span class="variable">environment</span>: <span class="type">SearchEnvironment</span>(
    <span class="comment">// Wrap the test scheduler in a type-erased scheduler</span>
    <span class="variable">mainQueue</span>: <span class="type">scheduler</span>.<span class="variable">eraseToAnyScheduler</span>(),
    <span class="comment">// Simulate a search response with one item</span>
    <span class="variable">request</span>: { <span class="keyword">_</span> <span class="keyword">in</span> <span class="variable">Effect</span>(<span class="variable">value</span>: [<span class="string literal">"</span><span class="string literal">Composable Architecture</span><span class="string literal">"</span>]) }
  )
)

<span class="comment">// Change the query</span>
<span class="variable">store</span>.<span class="variable">send</span>(.<span class="variable">searchFieldChanged</span>(<span class="string literal">"</span><span class="string literal">c</span><span class="string literal">"</span>) {
  <span class="comment">// Assert that state updates accordingly</span>
  <span class="variable">$0</span>.<span class="variable">query</span> = <span class="string literal">"</span><span class="string literal">c</span><span class="string literal">"</span>
}

<span class="comment">// Advance the scheduler by a period shorter than the debounce</span>
<span class="variable">scheduler</span>.<span class="variable">advance</span>(<span class="variable">by</span>: <span class="number literal">0.25</span>)

<span class="comment">// Change the query again</span>
<span class="variable">store</span>.<span class="variable">send</span>(.<span class="variable">searchFieldChanged</span>(<span class="string literal">"co"</span>) {
  <span class="variable">$0</span>.<span class="variable">query</span> = <span class="string literal">"co"</span>
}

<span class="comment">// Advance the scheduler by a period shorter than the debounce</span>
<span class="variable">scheduler</span>.<span class="variable">advance</span>(<span class="variable">by</span>: <span class="number literal">0.25</span>)
<span class="comment">// Advance the scheduler to the debounce</span>
<span class="variable">scheduler</span>.<span class="variable">advance</span>(<span class="variable">by</span>: <span class="number literal">0.25</span>)

<span class="comment">// Assert that the expected response is received</span>
<span class="variable">store</span>.<span class="variable">receive</span>(.<span class="variable">response</span>([<span class="string literal">"Composable Architecture"</span>])) {
  <span class="comment">// Assert that state updates accordingly</span>
  <span class="variable">$0</span>.<span class="variable">results</span> = [<span class="string literal">"Composable Architecture"</span>]
}
</code></pre></body></html>
<p>This test is proving that the debounced network requests are correctly canceled when we do not
wait longer than the 0.5 seconds, because if it wasn't and it delivered an action when we did
not expect it would cause a test failure.</p>

</div>
<section id="relationships">
    <h2 hidden>Relationships</h2>
        
        <h3>Nested Types</h3>
<dl>
    <dt class="structure"><code><a href="/swift-composable-architecture/TestStore_Step">TestStore.Step</a></code></dt>
<dd></dd>
</dl>
</section>
    <section id="properties">
        <h2>Properties</h2>

        <div role="article" class="variable" id="teststore.environment">
    <h3>
        <code><a href="#teststore.environment">environment</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">var</span> <span class="variable">environment</span>: <span class="type">Environment</span></body></html></code></pre>
</div>
</div>
    </section>
    <section id="methods">
        <h2>Methods</h2>

        <div role="article" class="function" id="teststore.scope(state:action:)">
    <h3>
        <code><a href="#teststore.scope(state:action:)">scope(state:​action:​)</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">func</span> <span class="function">scope</span>&lt;<span class="variable">S</span>, <span class="variable">A</span>&gt;(
      <span class="variable">state</span> <span class="variable">toLocalState</span>: <span class="attribute">@</span><span class="attribute">escaping</span> (<span class="type">LocalState</span>) -&gt; <span class="type">S</span>,
      <span class="variable">action</span> <span class="variable">fromLocalAction</span>: <span class="attribute">@</span><span class="attribute">escaping</span> (<span class="type">A</span>) -&gt; <span class="type">LocalAction</span>
    ) -&gt; <a href="/swift-composable-architecture/TestStore"><span class="type">TestStore</span></a>&lt;<span class="type">State</span>, <span class="type">S</span>, <span class="type">Action</span>, <span class="type">A</span>, <span class="type">Environment</span>&gt;  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Scopes a store to assert against more local state and actions.</p>

</div>
<div class="discussion">
    <p>Useful for testing view store-specific state and actions.</p>

</div>
<h4>Parameters</h4>

<table class="parameters">
  <thead hidden>
  <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
  </tr>
  </thead>
  <tbody>
    <tr>
    <th>to​Local​State</th>
    <td><code class="type">@escaping (Local​State) -&gt; S</code></td>
    <td><p>A function that transforms the reducer's state into more local state. This state will be asserted against as it is mutated by the reducer. Useful for testing view store state transformations.</p>
</td>
</tr>
<tr>
    <th>from​Local​Action</th>
    <td><code class="type">@escaping (A) -&gt; Local​Action</code></td>
    <td><p>A function that wraps a more local action in the reducer's action. Local actions can be &quot;sent&quot; to the store, while any reducer action may be received. Useful for testing view store action transformations.</p>
</td>
</tr>
  </tbody>
</table>
</div>
<div role="article" class="function" id="teststore.scope(state:)">
    <h3>
        <code><a href="#teststore.scope(state:)">scope(state:​)</a></code>
    </h3>
    <div class="declaration">
<pre class="highlight"><code><html><body><span class="keyword">public</span> <span class="keyword">func</span> <span class="function">scope</span>&lt;<span class="variable">S</span>&gt;(
      <span class="variable">state</span> <span class="variable">toLocalState</span>: <span class="attribute">@</span><span class="attribute">escaping</span> (<span class="type">LocalState</span>) -&gt; <span class="type">S</span>
    ) -&gt; <a href="/swift-composable-architecture/TestStore"><span class="type">TestStore</span></a>&lt;<span class="type">State</span>, <span class="type">S</span>, <span class="type">Action</span>, <span class="type">LocalAction</span>, <span class="type">Environment</span>&gt;  </body></html></code></pre>
</div>
<div class="summary" role="doc-abstract">
    <p>Scopes a store to assert against more local state.</p>

</div>
<div class="discussion">
    <p>Useful for testing view store-specific state.</p>

</div>
<h4>Parameters</h4>

<table class="parameters">
  <thead hidden>
  <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
  </tr>
  </thead>
  <tbody>
    <tr>
    <th>to​Local​State</th>
    <td><code class="type">@escaping (Local​State) -&gt; S</code></td>
    <td><p>A function that transforms the reducer's state into more local state. This state will be asserted against as it is mutated by the reducer. Useful for testing view store state transformations.</p>
</td>
</tr>
  </tbody>
</table>
</div>
    </section>



        </article>
    </main>

    <footer>
        <p>
    Generated on <time datetime="2022-03-15T20:32:50+0000">March 15, 2022</time> using <a href="https://github.com/SwiftDocOrg/swift-doc">swift-doc</a> <span class="version">1.0.0-rc.1</span>.
</p>
    </footer>
</body>
</html>
